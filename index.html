<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¶œí•˜ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #reader { width: 320px; margin: 10px 0; border: 1px solid #ccc; }
    #alert-box { min-height: 1.5em; font-weight: bold; margin: 10px 0; }
    #result-list div {
      margin-bottom: 5px; padding: 5px; border-bottom: 1px solid #eee;
      background: #f9f9f9;
    }
    .flash { background-color: #d4f4dd !important; transition: background 0.3s ease; }
    select, button { margin: 5px 5px 10px 0; padding: 6px; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ ì¶œí•˜ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h2>

  <label for="camera-select">ğŸ¥ ì¹´ë©”ë¼ ì„ íƒ:</label>
  <select id="camera-select"><option value="">-- ì„ íƒí•˜ì„¸ìš” --</option></select>
  <button id="start-button">â–¶ï¸ ìŠ¤ìº” ì‹œì‘</button>
  <button id="stop-button">â¹ï¸ ìŠ¤ìº” ì¤‘ì§€</button>

  <div id="reader"></div>
  <div id="alert-box"></div>

  <h3>ğŸ“‹ ìŠ¤ìº”ëœ ì¶œí•˜ ë¦¬ìŠ¤íŠ¸</h3>
  <div id="result-list"></div>

  <button id="save-text">ğŸ’¾ í…ìŠ¤íŠ¸ ì €ì¥</button>
  <button id="save-excel">ğŸ“Š ì—‘ì…€ ì €ì¥</button>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("camera-select");
    const resultList = document.getElementById("result-list");
    const alertBox = document.getElementById("alert-box");
    const beep = document.getElementById("beep");
    const scannedCodes = new Set();
    let isScanning = true;

    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        devices.forEach(device => {
          const option = document.createElement("option");
          option.value = device.id;
          option.textContent = device.label || `ì¹´ë©”ë¼ ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(option);
        });
      } catch {
        alertBox.textContent = "ğŸš« ì¹´ë©”ë¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }
    }

    function appendResult(code) {
      if (!isScanning) return;
      const today = new Date().toISOString().slice(0,10);
      const key = `${today} - ${code}`;

      if (scannedCodes.has(key)) {
        alertBox.textContent = "âš ï¸ ì´ë¯¸ ìŠ¤ìº”ëœ í•­ëª©ì…ë‹ˆë‹¤!";
        alertBox.style.color = "red";
        return;
      }

      beep.play();
      scannedCodes.add(key);
      const div = document.createElement("div");
      div.textContent = key;
      div.classList.add("flash");
      resultList.prepend(div); // ìµœì‹  í•­ëª©ì„ ìœ„ë¡œ

      setTimeout(() => div.classList.remove("flash"), 400);
      alertBox.textContent = "";
      isScanning = false;
      setTimeout(() => { isScanning = true; }, 1500); // ìŠ¤ìº” ê°„ê²©
    }

    loadCameras();

    document.getElementById("start-button").onclick = () => {
      const camId = cameraSelect.value;
      if (!camId) return alert("ì¹´ë©”ë¼ë¥¼ ì„ íƒí•˜ì„¸ìš”!");
      html5QrCode.start(
        camId, // ë¬¸ìì—´ë§Œ ì „ë‹¬
        {
          fps: 30,
          qrbox: { width: 300, height: 300 },
          aspectRatio: 1.333,
          videoConstraints: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            focusMode: "continuous"
          }
        },
        appendResult,
        () => {}
      ).catch(err => alert("ìŠ¤ìº” ì‹œì‘ ì‹¤íŒ¨: " + err));
    };

    document.getElementById("stop-button").onclick = () => {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        alertBox.textContent = "â¹ï¸ ìŠ¤ìº”ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.";
      });
    };

    document.getElementById("save-text").onclick = () => {
      const list = Array.from(scannedCodes);
      if (list.length === 0) return alert("ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
      const blob = new Blob([list.join("\n")], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `ì¶œí•˜ë¦¬ìŠ¤íŠ¸_${new Date().toISOString().slice(0,10)}.txt`;
      link.click();
    };

    document.getElementById("save-excel").onclick = () => {
      const rows = Array.from(scannedCodes).map(item => [item]);
      if (rows.length === 0) return alert("ìŠ¤ìº”ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
      const sheet = XLSX.utils.aoa_to_sheet([["ì¶œí•˜ì¼ì‹œ - ë°”ì½”ë“œ"], ...rows]);
      const book = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(book, sheet, "ì¶œí•˜ë¦¬ìŠ¤íŠ¸");
      XLSX.writeFile(book, `ì¶œí•˜ë¦¬ìŠ¤íŠ¸_${new Date().toISOString().slice(0,10)}.xlsx`);
    };
  </script>
</body>
</html>
