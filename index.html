<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>출하 바코드 스캐너 (최적화)</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #reader { width: 320px; margin: 10px 0; border: 1px solid #ccc; }
    #alert-box { min-height: 1.5em; font-weight: bold; margin-top: 10px; }
    #result-list div {
      margin-bottom: 5px; padding: 4px; border-bottom: 1px solid #eee;
      background: #f9f9f9;
    }
    .flash { background-color: #d4f4dd !important; transition: background 0.3s ease; }
    select, button { margin: 5px 5px 10px 0; padding: 6px; }
  </style>
</head>
<body>
  <h2>📦 빠른 출하 바코드 스캐너</h2>

  <label for="camera-select">🎥 카메라 선택:</label>
  <select id="camera-select"><option value="">-- 선택하세요 --</option></select>
  <button id="start-button">▶️ 스캔 시작</button>
  <button id="stop-button">⏹️ 스캔 중지</button>

  <div id="reader"></div>
  <div id="alert-box"></div>

  <h3>📋 스캔된 출하 리스트</h3>
  <div id="result-list"></div>

  <button id="save-text">💾 텍스트 저장</button>
  <button id="save-excel">📊 엑셀 저장</button>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const html5QrCode = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("camera-select");
    const alertBox = document.getElementById("alert-box");
    const resultList = document.getElementById("result-list");
    const beep = document.getElementById("beep");
    const scannedCodes = new Set();
    let isScanning = true;

    async function loadCameras() {
      try {
        const devices = await Html5Qrcode.getCameras();
        devices.forEach(device => {
          const option = document.createElement("option");
          option.value = device.id;
          option.textContent = device.label || `카메라 ${cameraSelect.length + 1}`;
          cameraSelect.appendChild(option);
        });
      } catch {
        alertBox.textContent = "🚫 카메라 불러오기 실패";
      }
    }

    function appendResult(code) {
      if (!isScanning) return;
      const today = new Date().toISOString().slice(0,10);
      const key = `${today} - ${code}`;

      if (scannedCodes.has(key)) {
        alertBox.textContent = "⚠️ 이미 스캔된 항목입니다!";
        alertBox.style.color = "red";
        return;
      }

      beep.play();
      scannedCodes.add(key);
      const div = document.createElement("div");
      div.textContent = key;
      div.classList.add("flash");
      resultList.appendChild(div);
      setTimeout(() => div.classList.remove("flash"), 400);

      isScanning = false;
      setTimeout(() => { isScanning = true; }, 1500); // 스캔 간격 1.5초로 단축
    }

    loadCameras();

    document.getElementById("start-button").onclick = () => {
      const camId = cameraSelect.value;
      if (!camId) return alert("카메라 선택 필요!");
      html5QrCode.start(
        { deviceId: { exact: camId } },
        {
          fps: 30, // 빠른 프레임
          qrbox: { width: 300, height: 300 },
          aspectRatio: 1.333
        },
        appendResult,
        () => {}
      ).catch(err => alert("스캔 시작 실패: " + err));
    };

    document.getElementById("stop-button").onclick = () => {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        alertBox.textContent = "⏹️ 스캔이 중지되었습니다.";
      });
    };

    document.getElementById("save-text").onclick = () => {
      const lines = Array.from(scannedCodes);
      if (lines.length === 0) return alert("스캔 항목 없음");
      const blob = new Blob([lines.join("\n")], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `출하리스트_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    document.getElementById("save-excel").onclick = () => {
      const data = Array.from(scannedCodes).map(item => [item]);
      if (data.length === 0) return alert("스캔 항목 없음");
      const sheet = XLSX.utils.aoa_to_sheet([["출하일시 - 바코드"], ...data]);
      const book = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(book, sheet, "출하리스트");
      XLSX.writeFile(book, `출하리스트_${new Date().toISOString().slice(0,10)}.xlsx`);
    };
  </script>
</body>
</html>
